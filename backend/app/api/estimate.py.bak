# --- SAFE PATCH (auto-creates router/analyze if missing) ---
try:
    router
except NameError:
    from fastapi import APIRouter
    router = APIRouter(prefix="/api/estimate", tags=["estimate"])

try:
    AnalyzeRequest
except NameError:
    from pydantic import BaseModel
    from typing import Optional
    class AnalyzeRequest(BaseModel):
        description: str
        locale: Optional[str] = "nb"

def _safe_analyze(desc: str, locale: str):
    try:
        if '_analyze_with_gpt' in globals():
            return _analyze_with_gpt(desc, locale)
    except Exception:
        pass
    # Minimalus fallback (ne "Terrasse")
    return {
        "materials": [{"name": "Takpapp SBS", "unit": "m²", "qty": 120}],
        "workflow": [{"task": "Taktekking papp", "hours": 8}],
        "crew": [{"role": "Taktekker", "count": 2}],
        "tools": ["Varmluftspistol", "Valsai"]
    }

@router.post("/analyze")
async def analyze(req: AnalyzeRequest):
    desc = req.description
    d = desc.lower()
    if (("garasje" in d or "garasj" in d) and ("plate på mark" in d or "plate pa mark" in d or "slab" in d)):
        desc += """
Forstå at dette er komplett nybygg av garasje med plate på mark.
Lag FULL liste: grunnarbeid/ringmur/plate (utgraving, pukk, EPS S80 100 mm, radonduk, armeringsnett K131, betong C25 100 mm, L-elementer),
bindingsverk 48x148, vindsperre, isolasjon ~150 mm, dampsperre, kledning,
takstoler, undertak/lekter, takpapp SBS, takrenner/nedløp,
åpninger (leddport 2,4×2,1, ytterdør 9×21, 2 vinduer 10×10),
festemateriell/småvarer. Fordel arbeid: betongarbeider + tømrer. Inkluder verktøy.
"""
    return _safe_analyze(req.description, (req.locale or "nb"))
# --- SAFE PATCH END ---
